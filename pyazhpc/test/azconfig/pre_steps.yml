steps:
  - task : AzureCLI@2
    displayName: "Create unit test resources"
    inputs:
      azureSubscription: 'target-subscription'
      scriptType: 'bash'
      scriptLocation: inlineScript
      inlineScript: |
        if [ "$SYSTEM_DEBUG" = "true" ]; then
          set -x
        fi

        # Create the RG to host test resources
        echo "Create Resource group $AZHPC_RESOURCEGROUP"
        az group create --name $AZHPC_RESOURCEGROUP --location $AZHPC_VARIABLES_LOCATION

        # extract the random value from the resource group
        random=$(echo $AZHPC_RESOURCEGROUP | cut -d '-' -f2)

        # Create a KeyVault and add a secret in it
        echo "Create Key Vault $AZHPC_RESOURCEGROUP"
        az keyvault create --name $AZHPC_RESOURCEGROUP --resource-group $AZHPC_RESOURCEGROUP

        echo "Add a secret"
        az keyvault secret set --vault-name $AZHPC_RESOURCEGROUP --name "secret" --value "secretvalue"

        # Create Log Analytics Workspace
        az monitor log-analytics workspace create -n $AZHPC_RESOURCEGROUP -g $AZHPC_RESOURCEGROUP

        
      failOnStandardError: false
    continueOnError: false

