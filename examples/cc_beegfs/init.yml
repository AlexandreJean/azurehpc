steps:
  - task : AzureCLI@2
    displayName: "Initializing config"
    inputs:
      azureSubscription: 'target-subscription'
      scriptType: 'bash'
      scriptLocation: inlineScript
      inlineScript: |
        if [ "$SYSTEM_DEBUG" = "true" ]; then
          set -x
          AZHPC_OPTION="--debug"
        fi

        echo "********************************************************************"
        echo "*                  INIT CONFIG VARIABLES                           *"
        echo "********************************************************************"
        # AZHPC_UUID is set when creating the RG unique name when starting the pipeline
        export AZHPC_VARIABLES_UUID=${AZHPC_UUID-azhpc}
        azhpc_variables=$(printenv | grep AZHPC_VARIABLES)
        init_variables="-v resource_group=$AZHPC_RESOURCEGROUP"
        for item in $azhpc_variables; do
            key=$(echo $item | cut -d '=' -f1)
            value=$(echo $item | cut -d '=' -f2)
            variable=${key#AZHPC_VARIABLES_}
            variable=${variable,,}
            init_variables+=",$variable=$value"
        done
        
        . install.sh
        conf_dir=$(dirname $AZHPC_CONFIG)
        if [ "$PROJECT_DIR" = "" ]; then
            PROJECT_DIR=${conf_dir##*/}
        fi
        config_file=$(basename $AZHPC_CONFIG)

        echo "Calling azhpc-init"
        azhpc-init $AZHPC_OPTION -c $BUILD_REPOSITORY_LOCALPATH/$conf_dir/$config_file -d $PROJECT_DIR $init_variables || exit 1
        pushd $PROJECT_DIR

        cp $BUILD_REPOSITORY_LOCALPATH/$conf_dir/init.sh .

        ./init.sh
        jq '.' prereqs.json

        azhpc-build --no-vnet -c prereqs.json


      failOnStandardError: false
    continueOnError: false

